<div class="container">
  <h1>{{ 'PROJECT_DETAILS.TITLE' | translate }}</h1>
  
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <p>{{ 'projectDetails.loading' | translate }}</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-state">
    <p>{{ 'projectDetails.error.notFound' | translate }}</p>
  </div>

  <!-- Project Details -->
  <div *ngIf="!isLoading && !error && project" class="details-container">
    <!-- Personal Information Section -->
    <div class="details-section">
      <h3>{{ 'PROJECT_DETAILS.SECTIONS.PERSONAL_INFO' | translate }}</h3>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.FULL_NAME' | translate }}:</strong>
        <span>{{ project.clientName }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.PROFESSIONAL_STATUS' | translate }}:</strong>
        <span>{{ project.professionalStatus }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.EMAIL' | translate }}:</strong>
        <span>{{ project.email }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.PHONE' | translate }}:</strong>
        <span>{{ project.phone }}</span>
      </div>
      <div class="detail-row" *ngIf="project.linkedIn">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.LINKEDIN' | translate }}:</strong>
        <a [href]="project.linkedIn" target="_blank" class="social-link">{{ project.linkedIn }}</a>
      </div>
    </div>

    <!-- Project Information Section -->
    <div class="details-section">
      <h3>{{ 'PROJECT_DETAILS.SECTIONS.PROJECT_INFO' | translate }}</h3>
      <!-- Project Thumbnail -->
      <div class="thumbnail-container" *ngIf="project.projectPhotoUrl">
        <img [src]="project.projectPhotoUrl" alt="Project Thumbnail" class="project-thumbnail">
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.PROJECT_NAME' | translate }}:</strong>
        <span>{{ project.projectName }}</span>
      </div>
      <div class="detail-row description-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.PROJECT_DESCRIPTION' | translate }}:</strong>
        <span>
          <span *ngIf="!shouldTruncate(project.description)">{{ project.description }}</span>
          <span *ngIf="shouldTruncate(project.description)">
            {{ getTruncatedText(project.description) }}
            <button class="view-more-btn" (click)="showFullTextPopup(project.description, 'description')">
              {{ 'projectDetails.actions.viewMore' | translate }}
            </button>
          </span>
        </span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.CATEGORY' | translate }}:</strong>
        <span>{{ project.category }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.LOCATION' | translate }}:</strong>
        <span>{{ project.projectLocation }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.STATUS' | translate }}:</strong>
        <span class="status-badge" [ngClass]="project.status.toLowerCase()">
          {{ project.status }}
        </span>
      </div>
      <div class="detail-row" *ngIf="project.prototypeLink">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.PROTOTYPE_LINK' | translate }}:</strong>
        <a [href]="project.prototypeLink" target="_blank" class="external-link">{{ project.prototypeLink }}</a>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.EMPLOYEES' | translate }}:</strong>
        <span>{{ project.numberOfEmp }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.MONTHLY_INCOME' | translate }}:</strong>
        <span class="currency-value">{{ project.monthlyIncome | currency }}</span>
      </div>
      <div class="detail-row" *ngIf="project.website">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.WEBSITE_URL' | translate }}:</strong>
        <a [href]="project.website" target="_blank" class="external-link">{{ project.website }}</a>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.SPECIALITY' | translate }}:</strong>
        <span>{{ project.specialityOfProject }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.PROJECT_PURPOSE' | translate }}:</strong>
        <span class="purpose-badge">{{ project.projectPurpose }}</span>
      </div>
    </div>

    <!-- Sponsorship Section -->
    <div class="details-section">
      <h3>{{ 'PROJECT_DETAILS.SECTIONS.SPONSORSHIP_INFO' | translate }}</h3>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.HAS_SPONSORSHIP' | translate }}:</strong>
        <span class="badge" [ngClass]="project.haveSponsorQ === 'Yes' ? 'badge-success' : 'badge-secondary'">
          {{ project.haveSponsorQ }}
        </span>
      </div>
      <div class="detail-row" *ngIf="project.haveSponsorQ === 'Yes'">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.SPONSOR_NAME' | translate }}:</strong>
        <span>{{ project.sponsorName }}</span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.NEEDS_SPONSOR' | translate }}:</strong>
        <span class="badge" [ngClass]="project.needSponsorQ === 'Yes' ? 'badge-warning' : 'badge-secondary'">
          {{ project.needSponsorQ }}
        </span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.SELL_PROJECT' | translate }}:</strong>
        <span class="badge" [ngClass]="project.doSellProjectQ === 'Yes' ? 'badge-info' : 'badge-secondary'">
          {{ project.doSellProjectQ }}
        </span>
      </div>
      <div class="detail-row" *ngIf="project.doSellProjectQ === 'Yes'">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.PROJECT_INVESTMENT' | translate }}:</strong>
        <span class="currency-value">{{ project.projectAmount | currency }}</span>
      </div>
    </div>

    <!-- Intellectual Property Section -->
    <div class="details-section">
      <h3>{{ 'PROJECT_DETAILS.SECTIONS.INTELLECTUAL_PROPERTY' | translate }}</h3>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.WANTS_IP' | translate }}:</strong>
        <span class="badge" [ngClass]="project.intellectualProjectQ === 'Yes' ? 'badge-success' : 'badge-secondary'">
          {{ project.intellectualProjectQ }}
        </span>
      </div>
      <div class="detail-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.NEEDS_BUSINESS_PLAN' | translate }}:</strong>
        <span class="badge" [ngClass]="project.wantOriginToBusinessPlanQ === 'Yes' ? 'badge-warning' : 'badge-secondary'">
          {{ project.wantOriginToBusinessPlanQ }}
        </span>
      </div>
      <div class="detail-row description-row">
        <strong>{{ 'PROJECT_DETAILS.FIELDS.BUSINESS_IDEA' | translate }}:</strong>
        <span>
          <span *ngIf="!shouldTruncate(project.businessIdea)">{{ project.businessIdea }}</span>
          <span *ngIf="shouldTruncate(project.businessIdea)">
            {{ getTruncatedText(project.businessIdea) }}
            <button class="view-more-btn" (click)="showFullTextPopup(project.businessIdea, 'businessIdea')">
              {{ 'projectDetails.actions.viewMore' | translate }}
            </button>
          </span>
        </span>
      </div>
    </div>

    <!-- Documents Section -->
    <div class="details-section">
      <h3>{{ 'PROJECT_DETAILS.SECTIONS.DOCUMENTS' | translate }}</h3>
      <div class="documents-grid">
        <div class="document-card" *ngIf="project.incomeStatementUrl">
          <div class="document-icon">
            <i class="fas fa-file-pdf"></i>
          </div>
          <div class="document-info">
            <div class="document-name">{{ 'PROJECT_DETAILS.FIELDS.INCOME_STATEMENT' | translate }}</div>
            <a [href]="project.incomeStatementUrl" target="_blank" class="btn btn-secondary">
              <i class="fas fa-download"></i> {{ 'COMMON.DOWNLOAD' | translate }}
            </a>
          </div>
        </div>
        <div class="document-card" *ngIf="project.businessPlanUrl">
          <div class="document-icon">
            <i class="fas fa-file-pdf"></i>
          </div>
          <div class="document-info">
            <div class="document-name">{{ 'PROJECT_DETAILS.FIELDS.BUSINESS_PLAN' | translate }}</div>
            <a [href]="project.businessPlanUrl" target="_blank" class="btn btn-secondary">
              <i class="fas fa-download"></i> {{ 'COMMON.DOWNLOAD' | translate }}
            </a>
          </div>
        </div>
        <div class="document-card" *ngIf="project.businessIdeaDocumentUrl">
          <div class="document-icon">
            <i class="fas fa-file-pdf"></i>
          </div>
          <div class="document-info">
            <div class="document-name">{{ 'PROJECT_DETAILS.FIELDS.BUSINESS_IDEA_DOCUMENT' | translate }}</div>
            <a [href]="project.businessIdeaDocumentUrl" target="_blank" class="btn btn-secondary">
              <i class="fas fa-download"></i> {{ 'COMMON.DOWNLOAD' | translate }}
            </a>
          </div>
        </div>
        <div class="document-card" *ngIf="project.cashFlowUrl">
          <div class="document-icon">
            <i class="fas fa-file-pdf"></i>
          </div>
          <div class="document-info">
            <div class="document-name">Cash Flow Statement</div>
            <a [href]="project.cashFlowUrl" target="_blank" class="btn btn-secondary">
              <i class="fas fa-download"></i> {{ 'COMMON.DOWNLOAD' | translate }}
            </a>
          </div>
        </div>
        <div class="document-card" *ngIf="project.balanceSheetUrl">
          <div class="document-icon">
            <i class="fas fa-file-pdf"></i>
          </div>
          <div class="document-info">
            <div class="document-name">Balance Sheet</div>
            <a [href]="project.balanceSheetUrl" target="_blank" class="btn btn-secondary">
              <i class="fas fa-download"></i> {{ 'COMMON.DOWNLOAD' | translate }}
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Status-specific sections -->
    <ng-container [ngSwitch]="project.status">
      <!-- Analytics Section for Approved Projects -->
      <div class="details-section" *ngSwitchCase="'APPROVED'">
        <h3>{{ 'PROJECT_DETAILS.SECTIONS.ANALYTICS' | translate }}</h3>
        <div class="document-card analytics">
          <div class="document-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="document-info">
            <div class="document-name">{{ 'PROJECT_DETAILS.FIELDS.BUSINESS_ANALYTICS' | translate }}</div>
            <p>Analytics data will be available when the project is fully processed.</p>
          </div>
        </div>
      </div>

      <!-- Declined Feedback Section -->
      <div class="details-section feedback-section" *ngSwitchCase="'DECLINED'">
        <h3>{{ 'PROJECT_DETAILS.SECTIONS.DECLINED_FEEDBACK' | translate }}</h3>
        <div class="feedback-content">
          <div class="feedback-message">
            <i class="fas fa-info-circle"></i>
            <p>{{ project.feedback }}</p>
          </div>
        </div>
      </div>

      <!-- Assigned Analyzers Section -->
      <div class="details-section analyzers-section" *ngSwitchCase="'PENDING'">
        <h3>{{ 'PROJECT_DETAILS.SECTIONS.ASSIGNED_ANALYZERS' | translate }}</h3>
        
        <!-- Loading state for analyzers -->
        <div *ngIf="analyzersLoading" class="analyzers-loading">
          <div class="loading-spinner"></div>
          <p>{{ 'common.loading' | translate }}</p>
        </div>

        <!-- Error state for analyzers -->
        <div *ngIf="analyzersError && !analyzersLoading" class="analyzers-error">
          <i class="fas fa-exclamation-triangle"></i>
          <p>{{ 'projectDetails.error.loadingAnalyzers' | translate }}</p>
          <button (click)="loadAnalyzers()" class="retry-button">
            {{ 'common.retry' | translate }}
          </button>
        </div>

        <!-- Analyzers grid -->
        <div *ngIf="!analyzersLoading && !analyzersError" class="analyzers-grid">
          <div class="analyzer-card" *ngFor="let analyzer of analyzers">
            <div class="analyzer-header">
              <div class="analyzer-info">
                <i class="fas fa-user-tie"></i>
                <h4>{{ analyzer.name }}</h4>
              </div>
                             <button 
                 class="unassign-btn" 
                 (click)="unassignProject(analyzer.id)"
                 [disabled]="unassigningProject"
                 title="Unassign analyzer from project">
                 <i class="fas" [ngClass]="unassigningProject ? 'fa-spinner fa-spin' : 'fa-minus'"></i>
               </button>
            </div>
            <div class="analyzer-body">
              <div class="expertise">
                <strong>{{ 'PROJECT_DETAILS.FIELDS.EXPERTISE' | translate }}:</strong>
                <span>{{ analyzer.expertise }}</span>
              </div>
            </div>
          </div>
          
          <!-- No analyzers message -->
          <div *ngIf="analyzers.length === 0" class="no-analyzers">
            <i class="fas fa-users"></i>
            <p>{{ 'projectDetails.noAnalyzers' | translate }}</p>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Assignment Section -->
  <div class="assignment-section" *ngIf="project && project.status === 'PENDING'">
    <h3>{{ 'PROJECT_DETAILS.ASSIGN_PROJECT' | translate }}</h3>
    <div class="assignment-form">
      <mat-form-field appearance="outline">
        <mat-label>{{ 'PROJECT_DETAILS.SELECT_ANALYZER' | translate }}</mat-label>
        <mat-select [(ngModel)]="selectedAnalyzer" [disabled]="analyzersLoading || analyzersError">
          <mat-option *ngFor="let analyzer of analyzers" [value]="analyzer.id">
            {{ analyzer.name }}
            <span class="analyzer-expertise-inline"> - {{ analyzer.expertise }}</span>
          </mat-option>
        </mat-select>
        <ng-template mat-select-trigger>
          {{ getSelectedAnalyzer()?.name }}
        </ng-template>
      </mat-form-field>
             <app-custom-button
           buttonClass="btn-save"
           type="button"
           (onClick)="assignProject()"
           [disabled]="!selectedAnalyzer || analyzersLoading || analyzersError || assigningProject"
         >
           <i class="fas" [ngClass]="assigningProject ? 'fa-spinner fa-spin' : ''"></i>
           {{ assigningProject ? ('COMMON.ASSIGNING' | translate) : ('COMMON.SAVE_CONTINUE' | translate) }}
       </app-custom-button>
    </div>
  </div>

  <!-- Full Text Popup Modal -->
  <div class="modal-overlay" *ngIf="showFullText" (click)="closeFullTextPopup()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ expandedField | titlecase }}</h3>
        <button class="close-btn" (click)="closeFullTextPopup()">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <p>{{ expandedText }}</p>
      </div>
    </div>
  </div>
</div>
