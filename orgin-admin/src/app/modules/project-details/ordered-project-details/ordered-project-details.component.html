<div class="container">
  <div class="header">
    <h1>{{ 'projectDetails.title' | translate }}</h1>
    <div class="header-actions">
      <button class="export-button" (click)="exportProjectToPdf()" [disabled]="exportingPdf" *ngIf="projectDetails && !loading && !error">
        <i class="material-icons" *ngIf="!exportingPdf">download</i>
        <i class="material-icons loading-spinner" *ngIf="exportingPdf">hourglass_empty</i>
        <span>{{ exportingPdf ? ('projectDetails.actions.exporting' | translate) : ('projectDetails.actions.export' | translate) }}</span>
      </button>
      <div class="back-button" (click)="goBack()">
        <i class="material-icons">arrow_back</i>
        <span>{{ 'projectDetails.backToProjects' | translate }}</span>
      </div>
    </div>
  </div>
  
  <!-- Loading state -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>{{ 'projectDetails.loading' | translate }}</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-icon">
      <i class="material-icons">error_outline</i>
    </div>
    <h3>{{ 'projectDetails.error.title' | translate }}</h3>
    <p class="error-message">{{ error }}</p>
    <button (click)="loadProjectDetails()" class="retry-button">
      <i class="material-icons">refresh</i>
      {{ 'projectDetails.error.retry' | translate }}
    </button>
  </div>

  <!-- Project details -->
  <div *ngIf="projectDetails && !loading && !error" class="project-details">
    <!-- Project Header -->
    <div class="project-header">
      <div class="project-title-section">
        <h2>{{ projectDetails.projectTitle }}</h2>
        <div class="project-meta">
          <span class="project-type">{{ projectDetails.projectType }}</span>
          <span class="project-location">
            <i class="material-icons">location_on</i>
            {{ projectDetails.projectLocation }}
          </span>
        </div>
      </div>
      <div class="status-badge" [ngClass]="getStatusClass(projectDetails.status)">
        <i class="material-icons status-icon">
          {{ getStatusIcon(projectDetails.status) }}
        </i>
        {{ projectDetails.status }}
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Project Information -->
        <div class="info-card">
          <div class="card-header">
            <i class="material-icons">description</i>
            <h3>{{ 'projectDetails.sections.projectInformation' | translate }}</h3>
          </div>
          <div class="card-content">
            <div class="info-item">
              <label>{{ 'projectDetails.fields.description' | translate }}</label>
              <p>
                <span *ngIf="!shouldTruncate(projectDetails.projectDescription)">{{ projectDetails.projectDescription }}</span>
                <span *ngIf="shouldTruncate(projectDetails.projectDescription)">
                  {{ getTruncatedText(projectDetails.projectDescription) }}
                  <button class="view-more-btn" (click)="showFullTextPopup(projectDetails.projectDescription, 'description')">
                    {{ 'projectDetails.actions.viewMore' | translate }}
                  </button>
                </span>
              </p>
            </div>
            <div class="info-item">
              <label>{{ 'projectDetails.fields.businessIdea' | translate }}</label>
              <p>
                <span *ngIf="!shouldTruncate(projectDetails.businessIdea)">{{ projectDetails.businessIdea }}</span>
                <span *ngIf="shouldTruncate(projectDetails.businessIdea)">
                  {{ getTruncatedText(projectDetails.businessIdea) }}
                  <button class="view-more-btn" (click)="showFullTextPopup(projectDetails.businessIdea, 'businessIdea')">
                    {{ 'projectDetails.actions.viewMore' | translate }}
                  </button>
                </span>
              </p>
            </div>
            <div class="info-item">
              <label>{{ 'projectDetails.fields.targetAudience' | translate }}</label>
              <p>
                <span *ngIf="!shouldTruncate(projectDetails.targetAudience)">{{ projectDetails.targetAudience }}</span>
                <span *ngIf="shouldTruncate(projectDetails.targetAudience)">
                  {{ getTruncatedText(projectDetails.targetAudience) }}
                  <button class="view-more-btn" (click)="showFullTextPopup(projectDetails.targetAudience, 'targetAudience')">
                    {{ 'projectDetails.actions.viewMore' | translate }}
                  </button>
                </span>
              </p>
            </div>
            <div class="info-item">
              <label>{{ 'projectDetails.fields.speciality' | translate }}</label>
              <p>
                <span *ngIf="!shouldTruncate(projectDetails.specialityOfProject)">{{ projectDetails.specialityOfProject }}</span>
                <span *ngIf="shouldTruncate(projectDetails.specialityOfProject)">
                  {{ getTruncatedText(projectDetails.specialityOfProject) }}
                  <button class="view-more-btn" (click)="showFullTextPopup(projectDetails.specialityOfProject, 'speciality')">
                    {{ 'projectDetails.actions.viewMore' | translate }}
                  </button>
                </span>
              </p>
            </div>
            <div class="info-item" *ngIf="projectDetails.references">
              <label>{{ 'projectDetails.fields.references' | translate }}</label>
              <p>
                <span *ngIf="!shouldTruncate(projectDetails.references)">{{ projectDetails.references }}</span>
                <span *ngIf="shouldTruncate(projectDetails.references)">
                  {{ getTruncatedText(projectDetails.references) }}
                  <button class="view-more-btn" (click)="showFullTextPopup(projectDetails.references, 'references')">
                    {{ 'projectDetails.actions.viewMore' | translate }}
                  </button>
                </span>
              </p>
            </div>
          </div>
        </div>

        <!-- Client Information -->
        <div class="info-card">
          <div class="card-header">
            <i class="material-icons">person</i>
            <h3>{{ 'projectDetails.sections.clientInformation' | translate }}</h3>
          </div>
          <div class="card-content">
            <div class="client-info">
              <div class="client-avatar">
                <i class="material-icons">account_circle</i>
              </div>
              <div class="client-details">
                <h4>{{ projectDetails.clientName }}</h4>
                <p class="company">{{ projectDetails.companyName }}</p>
                <p class="position">{{ projectDetails.professionalStatus }}</p>
              </div>
            </div>
            <div class="contact-info">
              <div class="contact-item">
                <i class="material-icons">email</i>
                <span>{{ projectDetails.email }}</span>
              </div>
              <div class="contact-item">
                <i class="material-icons">phone</i>
                <span>{{ projectDetails.phone }}</span>
              </div>
              <div class="contact-item" *ngIf="projectDetails.linkedIn">
                <i class="material-icons">link</i>
                <span *ngIf="isUrl(projectDetails.linkedIn)">
                  <a [href]="projectDetails.linkedIn" target="_blank" (click)="openUrl(projectDetails.linkedIn)">
                    LinkedIn Profile
                  </a>
                </span>
                <span *ngIf="!isUrl(projectDetails.linkedIn)">{{ projectDetails.linkedIn }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Project Requirements -->
        <div class="info-card">
          <div class="card-header">
            <i class="material-icons">assignment</i>
            <h3>{{ 'projectDetails.sections.projectRequirements' | translate }}</h3>
          </div>
          <div class="card-content">
            <div class="requirement-item">
              <div class="requirement-label">
                <i class="material-icons">sponsorship</i>
                <span>{{ 'projectDetails.fields.sponsorship' | translate }}</span>
              </div>
              <div class="requirement-value">
                <span class="badge" [ngClass]="projectDetails.doYouHaveSponsorship === 'Yes' ? 'yes' : 'no'">
                  {{ projectDetails.doYouHaveSponsorship }}
                </span>
              </div>
            </div>
            <div class="requirement-item" *ngIf="projectDetails.sponsorName">
              <div class="requirement-label">
                <i class="material-icons">person_add</i>
                <span>{{ 'projectDetails.fields.sponsorName' | translate }}</span>
              </div>
              <div class="requirement-value">
                <span>{{ projectDetails.sponsorName }}</span>
              </div>
            </div>
            <div class="requirement-item">
              <div class="requirement-label">
                <i class="material-icons">lightbulb</i>
                <span>{{ 'projectDetails.fields.intellectualProject' | translate }}</span>
              </div>
              <div class="requirement-value">
                <span class="badge" [ngClass]="projectDetails.doYouNeedIntellectualProject === 'Yes' ? 'yes' : 'no'">
                  {{ projectDetails.doYouNeedIntellectualProject }}
                </span>
              </div>
            </div>
            <div class="requirement-item">
              <div class="requirement-label">
                <i class="material-icons">business</i>
                <span>{{ 'projectDetails.fields.businessPlan' | translate }}</span>
              </div>
              <div class="requirement-value">
                <span class="badge" [ngClass]="projectDetails.doYouNeedBusinessPlan === 'Yes' ? 'yes' : 'no'">
                  {{ projectDetails.doYouNeedBusinessPlan }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Documents -->
        <div class="info-card">
          <div class="card-header">
            <i class="material-icons">folder</i>
            <h3>{{ 'projectDetails.sections.documents' | translate }}</h3>
          </div>
          <div class="card-content">
            <div class="document-item" *ngIf="projectDetails.businessIdeaDocumentUrl">
              <div class="document-icon">
                <i class="material-icons">description</i>
              </div>
              <div class="document-info">
                <h4>{{ 'projectDetails.documents.businessIdeaDocument' | translate }}</h4>
                <p>{{ 'projectDetails.documents.projectConcept' | translate }}</p>
                <small class="document-url">{{ getDocumentFilename(projectDetails.businessIdeaDocumentUrl, 'business-idea-document.pdf') }}</small>
              </div>
                             <div class="document-actions">
                 <button class="document-btn preview-btn" (click)="previewDocument(projectDetails.businessIdeaDocumentUrl, 'Business Idea Document')" title="Preview Document">
                   <i class="material-icons">visibility</i>
                   {{ 'projectDetails.actions.preview' | translate }}
                 </button>
                 <!-- <button class="document-btn download-btn" (click)="downloadDocument(projectDetails.businessIdeaDocumentUrl, getDocumentFilename(projectDetails.businessIdeaDocumentUrl, 'business-idea-document.pdf'))" title="Download Document">
                   <i class="material-icons">download</i>
                   Download
                 </button>-->
               </div>
            </div>
            <div class="document-item" *ngIf="projectDetails.businessPlanDocumentUrl">
              <div class="document-icon">
                <i class="material-icons">business_center</i>
              </div>
              <div class="document-info">
                <h4>{{ 'projectDetails.documents.businessPlanDocument' | translate }}</h4>
                <p>{{ 'projectDetails.documents.businessStrategy' | translate }}</p>
                <small class="document-url">{{ getDocumentFilename(projectDetails.businessPlanDocumentUrl, 'business-plan-document.pdf') }}</small>
              </div>
                             <div class="document-actions">
                 <button class="document-btn preview-btn" (click)="previewDocument(projectDetails.businessPlanDocumentUrl, 'Business Plan Document')" title="Preview Document">
                   <i class="material-icons">visibility</i>
                   {{ 'projectDetails.actions.preview' | translate }}
                 </button>
                 <!--<button class="document-btn download-btn" (click)="downloadDocument(projectDetails.businessPlanDocumentUrl, getDocumentFilename(projectDetails.businessPlanDocumentUrl, 'business-plan-document.pdf'))" title="Download Document">
                   <i class="material-icons">download</i>
                   Download
                 </button>-->
               </div>
            </div>
            <div class="no-documents" *ngIf="!projectDetails.businessIdeaDocumentUrl && !projectDetails.businessPlanDocumentUrl">
              <div class="no-documents-content">
                <i class="material-icons">folder_open</i>
                <p>{{ 'projectDetails.documents.noDocuments' | translate }}</p>
                <small>{{ 'projectDetails.documents.documentsWillAppear' | translate }}</small>
              </div>
            </div>
          </div>
        </div>

                 <!-- Status Information -->
         <div class="info-card" *ngIf="projectDetails.reasons">
           <div class="card-header">
             <i class="material-icons">info</i>
             <h3>{{ 'projectDetails.sections.additionalInformation' | translate }}</h3>
           </div>
           <div class="card-content">
             <div class="info-item">
               <label>{{ 'projectDetails.fields.reasons' | translate }}</label>
               <p>
                 <span *ngIf="!shouldTruncate(projectDetails.reasons)">{{ projectDetails.reasons }}</span>
                 <span *ngIf="shouldTruncate(projectDetails.reasons)">
                   {{ getTruncatedText(projectDetails.reasons) }}
                   <button class="view-more-btn" (click)="showFullTextPopup(projectDetails.reasons, 'reasons')">
                     {{ 'projectDetails.actions.viewMore' | translate }}
                   </button>
                 </span>
               </p>
             </div>
           </div>
         </div>

         <!-- Progress Section -->
         <div class="info-card">
           <div class="card-header">
             <i class="material-icons">trending_up</i>
             <h3>{{ 'projectDetails.sections.projectProgress' | translate }}</h3>
           </div>
           <div class="card-content">
             <div class="current-status">
               <div class="status-info">
                 <label>{{ 'projectDetails.status.currentStatus' | translate }}</label>
                 <div class="status-display">
                   <span class="status-badge" [ngClass]="getStatusClass(projectDetails.status)">
                     <i class="material-icons status-icon">
                       {{ getStatusIcon(projectDetails.status) }}
                     </i>
                     {{ projectDetails.status }}
                   </span>
                   <p class="status-description">{{ getStatusDescription(projectDetails.status) | translate }}</p>
                 </div>
               </div>
               
               <div class="status-actions" *ngIf="canChangeStatus()">
                 <button class="change-status-btn" (click)="openStatusChangeModal()">
                   <i class="material-icons">edit</i>
                   {{ 'projectDetails.actions.changeStatus' | translate }}
                 </button>
               </div>
             </div>

             <div class="status-workflow" *ngIf="canChangeStatus()">
               <label>{{ 'projectDetails.status.availableActions' | translate }}</label>
                               <div class="workflow-options">
                  <div class="workflow-option" *ngFor="let status of getAvailableStatuses()">
                    <i class="material-icons">{{ getStatusIcon(status) }}</i>
                    <span>{{ status }}</span>
                    <small>{{ getStatusDescription(status) | translate }}</small>
                  </div>
                </div>
             </div>

             <div class="status-workflow" *ngIf="!canChangeStatus()">
               <label>{{ 'projectDetails.status.projectStatus' | translate }}</label>
               <div class="workflow-complete">
                 <i class="material-icons">check_circle</i>
                 <span>{{ 'projectDetails.status.finalStatus' | translate }}</span>
                 <small>{{ 'projectDetails.status.noFurtherActions' | translate }}</small>
               </div>
             </div>
           </div>
         </div>
      </div>
    </div>
  </div>

  <!-- Full Text Popup Modal -->
  <div class="modal-overlay" *ngIf="showFullText" (click)="closeFullTextPopup()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ expandedField | titlecase }}</h3>
        <button class="close-btn" (click)="closeFullTextPopup()">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <p>{{ getFullText() }}</p>
      </div>
    </div>
  </div>

  <!-- Document Preview Popup Modal -->
  <div class="modal-overlay" *ngIf="showDocumentPreview" (click)="closeDocumentPreview()">
    <div class="document-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ previewDocumentTitle }}</h3>
                 <div class="modal-actions">
           <!-- <button class="action-btn download-btn" (click)="downloadDocument(previewDocumentUrl, getDocumentFilename(previewDocumentUrl, 'document.pdf'))" title="{{ 'projectDetails.actions.download' | translate }}">
             <i class="material-icons">download</i>
             {{ 'projectDetails.actions.download' | translate }}
           </button> -->
           <button class="close-btn" (click)="closeDocumentPreview()">
             <i class="material-icons">close</i>
           </button>
         </div>
      </div>
      <div class="document-modal-body">
        <iframe [src]="previewDocumentUrl | safeUrl" width="100%" height="100%" frameborder="0"></iframe>
      </div>
    </div>
  </div>

  <!-- Status Change Modal -->
  <div class="modal-overlay" *ngIf="showStatusChangeModal" (click)="closeStatusChangeModal()">
    <div class="status-modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ 'projectDetails.modals.changeStatus.title' | translate }}</h3>
        <button class="close-btn" (click)="closeStatusChangeModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
      <div class="modal-body">
        <div class="status-selection">
          <label>{{ 'projectDetails.modals.changeStatus.selectNewStatus' | translate }}</label>
          <div class="status-options">
            <div 
              class="status-option" 
              *ngFor="let status of getAvailableStatuses()"
              [ngClass]="{ 'selected': selectedNewStatus === status }"
              (click)="selectedNewStatus = status">
              <i class="material-icons">{{ getStatusIcon(status) }}</i>
                             <div class="status-details">
                 <span class="status-name">{{ status }}</span>
                 <small>{{ getStatusDescription(status) | translate }}</small>
               </div>
            </div>
          </div>
        </div>
        
        <div class="reason-input">
          <label>{{ 'projectDetails.modals.changeStatus.reasonForChange' | translate }}</label>
          <textarea 
            [(ngModel)]="statusChangeReason" 
            placeholder="{{ 'projectDetails.modals.changeStatus.reasonPlaceholder' | translate }}"
            rows="4">
          </textarea>
        </div>
        
        <div class="modal-actions">
          <button class="cancel-btn" (click)="closeStatusChangeModal()">
            {{ 'projectDetails.modals.changeStatus.cancel' | translate }}
          </button>
          <button 
            class="confirm-btn" 
            [disabled]="!selectedNewStatus || !statusChangeReason.trim()"
            (click)="changeProjectStatus()">
            {{ 'projectDetails.modals.changeStatus.confirm' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
